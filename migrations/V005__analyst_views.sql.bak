-- UCRM v1 â€” ANALYST-FACING VIEWS (stable contracts)

create or replace view v_cardio_cases as
select
  pr.procedure_sk,
  pr.registry_program_c,
  pr.procedure_dt,
  e.encounter_sk,
  e.admit_dt,
  e.discharge_dt,
  p.patient_sk,
  f.facility_sk,
  pr.procedure_type_c,
  pr.primary_indication_c,
  pr.fluoroscopy_time_min,
  pr.contrast_volume_ml
from ucrm_procedure pr
join ucrm_encounter e on e.encounter_sk = pr.encounter_sk
join ucrm_patient  p on p.patient_sk = e.patient_sk
join ucrm_facility f on f.facility_sk = e.facility_sk;

create or replace view v_outcomes_core as
select
  pr.procedure_sk,
  pr.registry_program_c,
  max(case when outcome_c = 'DEATH_INHOSP' then occurred_flag end) as death_inhosp,
  max(case when outcome_c = 'STROKE'       then occurred_flag end) as stroke_any,
  max(case when outcome_c = 'BLEED_BARC'   then occurred_flag end) as bleed_barc_any
from ucrm_outcome o
join ucrm_procedure pr on pr.procedure_sk = o.procedure_sk
group by pr.procedure_sk, pr.registry_program_c;

-- Door-to-balloon (CathPCI)
create or replace view v_cathpci_dbt as
select
  pr.procedure_sk,
  datediff(
    minute,
    min(case when m.measure_c = 'DBT_DOOR_TIME'    then m.measure_dt end),
    min(case when m.measure_c = 'DBT_BALLOON_TIME' then m.measure_dt end)
  ) as dbt_minutes
from ucrm_measure m
join ucrm_procedure pr on pr.procedure_sk = m.procedure_sk
where pr.registry_program_c = 'NCDR_CATHPCI'
group by pr.procedure_sk;

